#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#
###############ÊâãÂä®‰øÆÊîπ##############
name: RAX3000M-eMMC-hanwckf

on:
  # push:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      LAN_IP:
        description: 'ËÆæÁΩÆ LAN IP Âú∞ÂùÄ'
        required: true
        default: '192.168.6.1'
      WIFI_DRIVER:
        description: 'ÈÄâÊã© WiFi È©±Âä®ÁâàÊú¨'
        required: true
        default: 'v7.6.7.2-fw-20240823(Êé®Ëçê)'
        type: choice
        options:
          - v7.6.7.2-fw-20240823(Êé®Ëçê)
          - v7.6.6.1-fw-20230306(Êé®Ëçê)
          - v7.6.7.2-fw-default
          - v7.6.7.2-fw-20230306
          - v7.6.7.2-fw-20230330
          - v7.6.7.2-fw-20230411
          - v7.6.7.2-fw-20230717
          - v7.6.7.2-fw-20231024
          - v7.6.6.1-fw-default
          - v7.6.6.1-fw-20230330
          - v7.6.6.1-fw-20230411
          - v7.6.6.1-fw-20230717
          - v7.6.6.1-fw-20231024
          - v7.6.6.1-fw-20240823
      EEPROM:
        description: '‰ΩøÁî® nx30pro ÁöÑ EEPROM Âπ∂Âõ∫ÂÆö WiFi MAC Âú∞ÂùÄ'
        required: true
        default: true
        type: boolean
      APP_MTK:
        description: '‰ΩøÁî® luci-app-mtk WiFi ÈÖçÁΩÆ'
        required: true
        default: false
        type: boolean
      NO_DOCKERMAN:
        description: '‰∏çÁºñËØë luci-app-dockerman'
        required: true
        default: false
        type: boolean
      ssh:
        description: 'ÊòØÂê¶ÂêØÁî® SSH ËøûÊé•'
        required: false
        default: 'false'
      USE_52MHZ:
        description: 'ÂêØÁî® 52MHz È´òÈ¢ëÁéá'
        required: true
        default: false
        type: boolean
  schedule:
    #Âåó‰∫¨Êó∂Èó¥ (UTC+8) ÊØèÂë®‰∏ÄÁöÑ 00:00ÔºàÂçàÂ§úÔºâ
    - cron: '0 16 * * 0'

    # - cron: '0 3 * * *'

env:
  ###############ÊâãÂä®‰øÆÊîπ##############
  ##Âõ†‰∏∫ÊòØ‰∏§‰∏™ËÆæÂ§áÔºåÊâÄ‰ª•ÊâãÂä®ËÆæÁΩÆ‰∏ä‰º†Êó∂ÂÄôÁöÑÊâìÂåÖÂêçÁß∞ÂíåtagÂêçÁß∞UPLOAD_TAG_NAME
  OPENWRT_NAME: hanwckf
  UPLOAD_TAG_NAME: rax3000m-emmc
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: RAX3000M-eMMC_XR30-eMMC-hanwckf/feeds.conf.default
  RAX3000M_EMMC_DTS_FILE: target/linux/mediatek/files-5.4/arch/arm64/boot/dts/mediatek/mt7981-cmcc-rax3000m-emmc.dts
  CONFIG_FILE: RAX3000M-eMMC_XR30-eMMC-hanwckf/.mtwifi-cfg.config
  DIY_P1_SH: RAX3000M-eMMC_XR30-eMMC-hanwckf/diy-part1.sh
  DIY_P2_SH: RAX3000M-eMMC_XR30-eMMC-hanwckf/diy-part2.sh
  #SSH_ACTIONS: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    # Job Á∫ßÂà´ÁöÑÁéØÂ¢ÉÂèòÈáèÔºöËøô‰∫õÂèòÈáè‰ºöÊ†πÊçÆËß¶Âèë‰∫ã‰ª∂Âä®ÊÄÅËÆæÁΩÆ
    env:
      # LAN_IP: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ LAN_IPÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº '192.168.6.1'
      LAN_IP: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.LAN_IP || '192.168.6.1' }}

      # WIFI_DRIVER: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ WIFI_DRIVERÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº
      WIFI_DRIVER: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.WIFI_DRIVER || 'v7.6.7.2-fw-20240823(recommend)' }}

      # EEPROM: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ EEPROMÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº true (Â∏ÉÂ∞îÂÄº)
      EEPROM: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.EEPROM || true }}

      # APP_MTK: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ APP_MTKÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº false (Â∏ÉÂ∞îÂÄº)
      APP_MTK: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.APP_MTK || false }}

      # NO_DOCKERMAN: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ NO_DOCKERMANÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº false (Â∏ÉÂ∞îÂÄº)
      NO_DOCKERMAN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.NO_DOCKERMAN || false }}

      # SSH_ACTIONS: Â∞Ü workflow_dispatch ÁöÑ 'ssh' ËæìÂÖ•ÔºàÂ≠óÁ¨¶‰∏≤ÔºâËΩ¨Êç¢‰∏∫Â∏ÉÂ∞îÂÄº„ÄÇ
      # Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶Âèë‰∏îËæìÂÖ• 'ssh' ÊòØ 'true'ÔºåÂàô‰∏∫ trueÔºõÂê¶Âàô‰∏∫ false„ÄÇ
      SSH_ACTIONS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ssh == 'true' || false }}

      # USE_52MHZ: Â¶ÇÊûúÊòØ workflow_dispatch Ëß¶ÂèëÔºåÂàô‰ΩøÁî®ËæìÂÖ•ÁöÑ USE_52MHZÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº false (Â∏ÉÂ∞îÂÄº)
      USE_52MHZ: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.USE_52MHZ || false }}

    steps:
      - name: ÊâìÂç∞ÊâÄÊúâÁéØÂ¢ÉÂèòÈáè
        run: |
          echo "--- ÂÖ®Â±ÄÁéØÂ¢ÉÂèòÈáè ---"
          echo "OPENWRT_NAME: $OPENWRT_NAME"
          echo "UPLOAD_TAG_NAME: $UPLOAD_TAG_NAME"
          echo "REPO_URL: $REPO_URL"
          echo "REPO_BRANCH: $REPO_BRANCH"
          echo "FEEDS_CONF: $FEEDS_CONF"
          echo "RAX3000M_EMMC_DTS_FILE: $RAX3000M_EMMC_DTS_FILE"
          echo "CONFIG_FILE: $CONFIG_FILE"
          echo "DIY_P1_SH: $DIY_P1_SH"
          echo "DIY_P2_SH: $DIY_P2_SH"
          echo "UPLOAD_FIRMWARE: $UPLOAD_FIRMWARE"
          echo "UPLOAD_RELEASE: $UPLOAD_RELEASE"
          echo "TZ: $TZ"
          echo "--- Job Âä®ÊÄÅÁéØÂ¢ÉÂèòÈáè ---"
          echo "LAN_IP: $LAN_IP"
          echo "WIFI_DRIVER: $WIFI_DRIVER"
          echo "EEPROM: $EEPROM"
          echo "APP_MTK: $APP_MTK"
          echo "NO_DOCKERMAN: $NO_DOCKERMAN"
          echo "SSH_ACTIONS: $SSH_ACTIONS"
          echo "USE_52MHZ: $USE_52MHZ"

      - name: Ê£ÄÊü•È°πÁõÆÂàÜÊîØ
        uses: actions/checkout@main

      # - name: ÁºìÂ≠òÁºñËØë‰æùËµñ
      #   id: cache
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       /var/cache/apt/archives/*.deb
      #       /workdir/openwrt
      #       /workdir/openwrt/dl
      #       /workdir/.ccache
      #     key: ${{ runner.os }}-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ github.sha }}-${{ hashFiles('RAX3000M-eMMC_XR30-eMMC-hanwckf/feeds.conf.default') }}
      #     restore-keys: |
      #       ${{ runner.os }}-build-${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-

      # - name: üì£ Log Cache Status
      #   run: |
      #     if [ "${{ steps.cache.outputs.cache-hit }}" == 'true' ]; then
      #       echo "‚úÖ Cache HIT: ‰ΩøÁî®ÁºìÂ≠òÊàêÂäü"
      #     else
      #       echo "‚ùå Cache MISS: È¶ñÊ¨°ÁºñËØëÊàñÈÖçÁΩÆÂ∑≤ÂèòÊõ¥ÔºåÊú™ÂëΩ‰∏≠ÁºìÂ≠ò"
      #     fi
      #     echo "CACHE_HIT=${{ steps.cache.outputs.cache-hit }}" >> $GITHUB_ENV

      - name: ÂàùÂßãÂåñÁºñËØëÁéØÂ¢É
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          # sudo apt-get install -y build-essential clang flex g++ gawk \ 
          #  gcc-multilib gettext git libncurses-dev libssl-dev python3-distutils \
          #  rsync unzip zlib1g-dev file wget ccache libelf-dev xsltproc
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -rf /var/cache/apt/archives/partial
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          echo "export PATH=/usr/lib/ccache:\$PATH" >> $HOME/.bashrc
          echo "export CCACHE_DIR=/workdir/.ccache" >> $HOME/.bashrc
          source $HOME/.bashrc

      - name: Ê∏ÖÁêÜÁ£ÅÁõòÁ©∫Èó¥(Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # when set to "true" but frees about 6 GB
          tool-cache: true

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: false
          dotnet: false
          haskell: false
          large-packages: false
          swap-storage: false

      - name: ‰∏ãËΩΩÂõ∫‰ª∂Ê∫êÁ†Å
        working-directory: /workdir
        run: |
          df -hT $PWD
          if [ ! -d "openwrt" ]; then
            git clone $REPO_URL -b $REPO_BRANCH openwrt
          else
            cd openwrt
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
          fi
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Âä†ËΩΩfeeds.conf.default & DIY_P1_SH
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: Êõ¥Êñ∞ & ÂÆâË£Ö feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Âä†ËΩΩconfig & DIY_P2_SH
        run: |
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: ËÆæÁΩÆRAX3000M-eMMCÁöÑeMMC‰ΩøÁî®highspeed
        if: env.USE_52MHZ == 'true'
        run: |
          cd openwrt
          if ! grep -q 'cap-mmc-highspeed' "${{ env.RAX3000M_EMMC_DTS_FILE }}"; then
                  sed -i -e '/bus-width = <8>;/ a\	cap-mmc-highspeed;' "${{ env.RAX3000M_EMMC_DTS_FILE }}"
          fi

      - name: ËÆæÁΩÆLAN IPÂú∞ÂùÄÔºàË∑ØÁî±Âô®ÁôªÂΩïÂú∞ÂùÄÔºâ
        run: |
          cd openwrt
          SET_IP="${{ env.LAN_IP }}" # ÊàñËÄÖÊõ¥ÁÆÄÊ¥ÅÂú∞ÂÜôÊàê SET_IP="$LAN_IP"
          if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
              #‰øÆÊîπimmortalwrt.lanÂÖ≥ËÅîIP
              sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" $(find feeds/luci/modules/luci-mod-system -type f -name "flash.js")
              #‰øÆÊîπÈªòËÆ§IPÂú∞ÂùÄ
              sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            echo "ËÆæÁΩÆ LAN IP Âú∞ÂùÄ: $SET_IP"
          else
              echo "ÈîôËØØÔºöLAN IP Âú∞ÂùÄ ($SET_IP) Êó†Êïà„ÄÇÂ∞Ü‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ„ÄÇ"
          fi

      - name: ËÆæÁΩÆWiFiÈ©±Âä®ÁâàÊú¨
        run: |
          cd openwrt
          wifi_driver=$(echo "${{ env.WIFI_DRIVER }}" | sed -E 's/^(v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          firmware=$(echo "${{ env.WIFI_DRIVER }}" | sed -E 's/.*fw-([0-9]{8}|default).*/\1/g')
          if [ "$wifi_driver" == "v7.6.6.1" ]; then
                  sed -i 's/CONFIG_MTK_MT_WIFI_DRIVER_VERSION_7672=y/CONFIG_MTK_MT_WIFI_DRIVER_VERSION_7661=y/g' .config
          fi
          if [ "$firmware" == "default" ]; then
                  sed -i 's/CONFIG_MTK_MT_WIFI_MT7981_20240823=y/CONFIG_MTK_MT_WIFI_MT7981_DEFAULT_FIRMWARE=y/g' .config
          else
          	sed -i "s/CONFIG_MTK_MT_WIFI_MT7981_20240823=y/CONFIG_MTK_MT_WIFI_MT7981_${firmware}=y/g" .config
          fi
          echo "Use WiFi Driver: $wifi_driver-fw-$firmware"

      - name: ‰ΩøÁî®nx30proÁöÑÈ´òÂäüÁéáeepromÂπ∂Âõ∫ÂÆöWiFi MACÂú∞ÂùÄ
        if: env.EEPROM == 'true'
        run: |
          cd openwrt
          wifi_driver=$(echo "${{ env.WIFI_DRIVER }}" | sed -E 's/^(v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [ "$wifi_driver" == "v7.6.6.1" ]; then
                  cp $GITHUB_WORKSPACE/RAX3000M-eMMC_XR30-eMMC-hanwckf/mt79xx_20220907-8b55f5_eeprom.tar.xz dl/mt79xx_20220907-8b55f5.tar.xz
          else
                  cp $GITHUB_WORKSPACE/RAX3000M-eMMC_XR30-eMMC-hanwckf/mt79xx_20231229-4012a0_eeprom.tar.xz dl/mt79xx_20231229-4012a0.tar.xz
          fi
          ## ÂàõÂª∫‰∏Ä‰∏™ËæÖÂä©Êñá‰ª∂„ÄÇÊñá‰ª∂ÂÜÖÂÆπÊòØÂÜôÂÖ•MACÂú∞ÂùÄÂà∞datÊñá‰ª∂ÔºåÂõ∫ÂÆöwifi MACÂú∞ÂùÄ
          echo -e "\t\tlocal wifi0_mac=\"\$(mmc_get_mac_binary factory 0x04)\"
          \t\tsed -i \"/^MacAddress=.*/ {s/.*/MacAddress=\$wifi0_mac/;b;}; \\\$aMacAddress=\$wifi0_mac\" /etc/wireless/mediatek/mt7981.dbdc.b0.dat
          \t\tlocal wifi1_mac=\"\$(macaddr_setbit_la \$wifi0_mac)\"
          \t\tsed -i \"/^MacAddress=.*/ {s/.*/MacAddress=\$wifi1_mac/;b;}; \\\$aMacAddress=\$wifi1_mac\" /etc/wireless/mediatek/mt7981.dbdc.b1.dat" > temp_insert.txt
          ## Â∞ÜÊñáÊú¨ÂÜÖÂÆπÂÜôÂÖ•02_network
          sed -i '/mediatek_setup_macs()/,/\};/ {/cmcc,rax3000m-emmc)/ {n;n;n;r temp_insert.txt
          }}' target/linux/mediatek/mt7981/base-files/etc/board.d/02_network

      - name: ‰ΩøÁî®luci-app-mtkÊó†Á∫øÈÖçÁΩÆ
        if: env.APP_MTK == 'true'
        run: |
          cd openwrt
          sed -i 's/CONFIG_PACKAGE_luci-app-mtwifi-cfg=y/CONFIG_PACKAGE_luci-app-mtk=y/g' .config
          sed -i 's/CONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y/CONFIG_PACKAGE_luci-i18n-mtk-zh-cn=y/g' .config
          sed -i 's/CONFIG_PACKAGE_mtwifi-cfg=y/CONFIG_PACKAGE_wifi-profile=y/g' .config
          sed -i 's/CONFIG_PACKAGE_lua-cjson=y/CONFIG_WIFI_NORMAL_SETTING=y/g' .config

      - name: ÂèñÊ∂àÁºñËØëdockerman
        if: env.NO_DOCKERMAN == 'true'
        run: |
          cd openwrt
          sed -i '/CONFIG_PACKAGE_luci-app-dockerman=y/d' .config

      - name: SSHÈìæÊé•ÁÆ°ÁêÜ
        uses: P3TERX/ssh2actions@v1.0.0
        if: env.SSH_ACTIONS == 'true'
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: ‰∏ãËΩΩÂÆâË£ÖÂåÖ
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: üïí Start Time
        run: echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

      - name: ÁºñËØëÂõ∫‰ª∂
        id: compile
        run: |
          cd openwrt
          # echo -e "$(nproc) thread compile"
          echo -e "$(( $(nproc) * 3 / 2 )) Á∫øÁ®ãÁºñËØëÔºåbÂêØÁî® ccache"
          # make -j$(nproc) || make -j1 || make -j1 V=s
          # make -j$(( $(nproc) * 3 / 2 )) CCACHE=1 || make -j1 CCACHE=1 V=s
          make -j$(( $(nproc) * 3 / 2 )) || make -j1 V=s

          sed -n 's/.*lan) ipad=${ipaddr:-"\([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\)"} ;;.*/\1/p' package/base-files/files/bin/config_generate | head -n 1 > IP_ADDR
          [ -s IP_ADDR ] && echo "IP_ADDR=$(cat IP_ADDR)" >> $GITHUB_ENV
          if grep -q 'CONFIG_MTK_MT_WIFI_DRIVER_VERSION_7661=y' .config; then
                  echo "WIFI_VERSION=-v7661" >> $GITHUB_ENV
          else
                  echo "WIFI_VERSION=-v7672" >> $GITHUB_ENV
          fi
          if [ "$EEPROM" == "true" ]; then
                  echo "EEPROM=-eeprom" >> $GITHUB_ENV
          else
                  echo "EEPROM=" >> $GITHUB_ENV
          fi
          if [ "$USE_52MHZ" == "true" ]; then
                  echo "USE52MHZ=-use52mhz" >> $GITHUB_ENV
          else
                  echo "USE52MHZ=" >> $GITHUB_ENV
          fi
          if grep -q 'CONFIG_PACKAGE_mtwifi-cfg=y' .config; then
                  echo "WIFI_INTERFACE=-mtwifi" >> $GITHUB_ENV
          else
                  echo "WIFI_INTERFACE=" >> $GITHUB_ENV
          fi
          if grep -q 'CONFIG_PACKAGE_luci-app-dockerman=y' .config; then
                  echo "BUILD_DOCKERMAN=-docker" >> $GITHUB_ENV
          else
                  echo "BUILD_DOCKERMAN=" >> $GITHUB_ENV
          fi
          echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Êü•ÁúãÁ£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ
        if: (!cancelled())
        run: df -hT

      - name: Êï¥ÁêÜÊñá‰ª∂Âπ∂ÈáçÂëΩÂêç
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mapfile -t devices < <(grep '^CONFIG_TARGET_DEVICE.*=y' openwrt/.config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          cd openwrt/bin/targets/*/*
          rm -rf packages
          for val in "${devices[@]}"; do
            for f in *"$val"*; do
              newname="${{ env.FILE_DATE }}-${{ env.OPENWRT_NAME }}-${val}${{ env.WIFI_VERSION }}${{ env.EEPROM }}${{ env.BUILD_DOCKERMAN }}${f##*$val}"
              mv -v "$f" "$newname"
            done
            echo "$val"
          done
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: üìù Generate Build Summary
        if: steps.compile.outputs.status == 'success'
        run: |
          mkdir -p summary
          BUILD_END=$(date +%s)
          DURATION=$((BUILD_END - BUILD_START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          {
            echo "üß± OpenWrt ÊûÑÂª∫ÊëòË¶Å"
            echo "---------------------"
            echo "üìÖ ÊûÑÂª∫Êó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "üïí ÊûÑÂª∫ÊÄªËÄóÊó∂: ${MINUTES} ÂàÜ ${SECONDS} Áßí"
            echo "üíæ ÁºìÂ≠ò: $([ "$CACHE_HIT" = true ] && echo '‚úÖ ÂëΩ‰∏≠' || echo '‚ùå Êú™ÂëΩ‰∏≠')"
            echo "üåê ËÆæÂ§á IP ÈªòËÆ§Âú∞ÂùÄ: $IP_ADDR"
          } | tee -a release.txt
          echo "üìÅ Âõ∫‰ª∂ËæìÂá∫ÁõÆÂΩï: $FIRMWARE"

      - name: ÊâìÂåÖ‰∏ä‰º†Âõ∫‰ª∂Âà∞Actions Artifacts
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ${{ env.FILE_DATE }}-${{ env.OPENWRT_NAME }}-${{ env.UPLOAD_TAG_NAME }}${{ env.WIFI_VERSION }}${{ env.EEPROM }}${{ env.BUILD_DOCKERMAN }}
          path: ${{ env.FIRMWARE }}

      - name: ÁîüÊàêÂõ∫‰ª∂ReleaseÊ†áÁ≠æ
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          touch release.txt
          {
            echo "- ‰ΩøÁî®Ê∫êÁ†ÅÔºö${{ env.REPO_URL }}"
            echo "- ‰ΩøÁî®ÂàÜÊîØÔºö${{ env.REPO_BRANCH }}"
            echo "- ÁôªÂΩïÂú∞ÂùÄÔºö$IP_ADDR"
            echo "- ‰ΩøÁî®WiFiÈ©±Âä®${{ env.WIFI_DRIVER }}"
            if [[ "$EEPROM" == '-eeprom' ]]; then
                    echo "- ‰ΩøÁî®nx30proÈ´òÂäüÁéáeepromÂπ∂Âõ∫ÂÆöWiFi MACÂú∞ÂùÄ"
            else
                  echo "- Êú™‰ΩøÁî®nx30proÈ´òÂäüÁéáeepromÊú™Âõ∫ÂÆöWiFi MACÂú∞ÂùÄ"
            fi
            if [[ "$USE52MHZ" == '-use52mhz' ]]; then
                    echo "- ‰ΩøÁî®52MHZ"
            else
                  echo "- Êú™‰ΩøÁî®52MHZ,ÈªòËÆ§26MHZ"
            fi
            if [[ "$WIFI_INTERFACE" == '-mtwifi' ]]; then
                    echo "- ‰ΩøÁî®hanwckf mtwifi-cfgÂéüÁîüluciÊó†Á∫øÈÖçÁΩÆÂ∑•ÂÖ∑"
            else
                    echo "- ‰ΩøÁî®mtk-sdk luci-app-mtkÊó†Á∫øÈÖçÁΩÆÂ∑•ÂÖ∑"
            fi
            if [[ "$BUILD_DOCKERMAN" == '-docker' ]]; then
                    echo "- Â∑≤ÁºñËØëluci-app-dockerman"
            else
                    echo "- Êú™ÁºñËØëluci-app-dockerman"
            fi
          } | tee -a release.txt
          echo "release_tag=${{ env.FILE_DATE }}-${{ env.OPENWRT_NAME }}-${{ env.UPLOAD_TAG_NAME }}${{ env.WIFI_VERSION }}${{ env.EEPROM }}${{ env.BUILD_DOCKERMAN }}" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ÂèëÂ∏ÉÂõ∫‰ª∂Ëá≥Release
        uses: softprops/action-gh-release@v2.1.0
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ${{ env.FIRMWARE }}/*
            release.txt
          name: ${{ env.FILE_DATE }}-${{ env.OPENWRT_NAME }}-${{ env.UPLOAD_TAG_NAME }}${{ env.WIFI_VERSION }}${{ env.EEPROM }}${{ env.BUILD_DOCKERMAN }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
